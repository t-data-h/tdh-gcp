---
# TDH Prerequisites
- name: Remove Packages
  become: true
  when: ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux'
  ansible.builtin.yum:
    name: '{{ yum_remove_packages }}'
    lock_timeout: 180
    state: absent

- name: Add/Update OpenJDK (RHEL/CentOS)
  become: true
  when: ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux'
  ansible.builtin.yum:
    name: '{{ yum_java_packages }}'
    state: present

- name: Add/Update OpenJDK (Debian/Ubuntu)
  become: true
  when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'
  ansible.builtin.yum:
    name: '{{ apt_java_packages }}'
    state: present

- name: Copy Java Bash Profile
  become: true
  ansible.builtin.template:
    src: '{{ jdk_sh_template }}'
    dest: '/etc/profile.d/jdk.sh'
    mode: '0644'

- name: Copy Java Csh Profile
  become: true
  ansible.builtin.template:
    src: '{{ jdk_csh_template }}'
    dest: '/etc/profile.d/jdk.csh'
    mode: '0644'

- name: Create JVM Link (RHEL/CentOS)
  become: true
  when: ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux'
  ansible.builtin.file:
    src: '/usr/lib/jvm/java-1.17.0-openjdk'
    dest: '/usr/lib/jvm/default-java'
    owner: 'root'
    group: 'root'
    state: link

- name: Create JVM Link (Debian/Ubuntu)
  become: true
  when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'
  ansible.builtin.file:
    src: '/usr/lib/jvm/java-17-openjdk-amd64'
    dest: '/usr/lib/jvm/default-java'
    owner: 'root'
    group: 'root'
    state: link

- name: Install Packages (RHEL/CentOS)
  become: true
  when: ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux'
  ansible.builtin.yum:
    name: '{{ yum_install_packages }}'
    lock_timeout: 180
    state: present

- name: Install Packages (Debian/Ubuntu)
  become: true
  when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'
  ansible.builtin.yum:
    name: '{{ apt_install_packages }}'
    state: present

- name: Copy sysctl config
  become: true
  ansible.builtin.template:
    src: '{{ sysctl_conf_template }}'
    dest: "/etc/sysctl.conf"
    mode: '0644'
  notify: Source_sysctl

- name: Copy rc local
  become: true
  when: ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux'
  ansible.builtin.template:
    src: '{{ rc_local_template }}'
    dest: "/etc/rc.d/rc.local"
    mode: '0755'

- name: Copy rc local
  become: true
  when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'
  ansible.builtin.template:
    src: '{{ rc_local_template }}'
    dest: "/etc/rc.local"
    mode: '0755'

- name: Copy security limits.conf
  become: true
  ansible.builtin.template:
    src: '{{ security_limits_conf }}'
    dest: "/etc/security/limits.conf"
    mode: '0644'

- name: Copy security 20-nproc.conf
  become: true
  ansible.builtin.template:
    src: '{{ security_nproc_conf }}'
    dest: "/etc/security/limits.d/20-nproc.conf"
    mode: '0644'

- name: Copy selinux.conf
  become: true
  ansible.builtin.template:
    src: '{{ se_linux_conf }}'
    dest: "/etc/selinux/config"
    mode: '0644'
  notify: Selinux_setenforce

- name: Create Log Directories
  become: true
  ansible.builtin.file:
    path: '{{ item }}'
    group: '{{ tdh_group }}'
    state: directory
    mode: '0775'
  with_items: '{{ tdh_dirs }}'
